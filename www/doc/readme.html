<!DOCTYPE HTML>
<html> <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta charset="utf-8">
  <link rel="shortcut icon" href="../z5r.ico" />
<title>ACSWebAdmin - Справка</title>
  <link rel="stylesheet" href="../style.css" type="text/css" />
</head>

<body>
<div class="div_sysname"><a href="../admin.php">ACS WebAdmin</a></div>

<div clas="main_div1">
<a name="about"></a>
<h2>ACSWebAdmin - о системе</h2>
Данная система служит для управления СКУД-контроллерами (IronLogic Z5RWeb), подключёнными к своему управляющему серверу методом WEB-JSON.
Система позволяет вести учёт контроллеров и ключей, их доступов, а также привязку к конкретным офисам.
Помимо этого поддерживается ведение списка скомпрометированных ключей, которые недопустимо добавлять в контроллеры.
Также реализована возможность проксирования событий - когда при обработке события определённого типа будет сделано обращение к другой системе.
Есть несколько базовых отчётов.
<Br/><Br/>
Основным принципом разработки была простота и открытость кода, а также использование максимально простых и надёжных решений.
Все ключевые функции работоспособны в любом браузере. Браузер Links - поддерживается.
CSS / JavaScript - опциональны. Без них некоторые действия станут менее удобными, но никакие существенные функции не должны сломаться.
Интерфейс локализован, из коробки поддерживаются все официальные языки международного общения. Существенная их часть сделана
машинным переводом, в случае обнаружения неточностей просьба создавать issue или слать pull-реквесты.
<Br/><Br/>
Система состоит из следующих частей:
<ul>
<li> основной модуль для взаимодействия с контроллерами. Представлен файлом index.php<Br/>
Использование индексного файла позволяет не прописывать на контроллерах путь с точностью до файла, указывая лишь каталог, где установлена система.
В основном принимает POST-запросы от контроллеров и после их обработки отвечает им набором данных, для Z5RWeb - в формате JSON.
В случае детекта пользовательского браузера (User-Agent совпадает с RegExp-шаблоном из настроек) может сразу редиректить в админку.

<li> модуль администрирования и отчетов. Представлен файлом admin.php и каталогом /reports<Br/>
Отсюда делается вся настройка системы, именование/IP-привязка контроллеров, добавление/назначение/отзыв/удаление ключей, настройка офисов, логинов пользователей и их прав доступа, прокси-событий, построение отчётов.

<li> модуль внутреннего JSON-API. Представлен файлом ha-json.php<Br/>
Ряд действий, таких как управление ключами, вынесены отдельным файлом, что позволяет вызывать управляющие события из внешних систем.
При этом проверяется авторизация и списки доступных IP.

<li> дополнительные модули отвечают за двухфакторную авторизацию (totp, BitcoinECDSA), восстановление паролей (password-recovery.php) и локализацию интерфейса (/localization).
</ul>

<a name="admin"></a>
<h2>ACSWebAdmin - администрирование</h2>
Есть три места, откуда могут быть изменены настройки системы.

<Br/><Br/>
<b>1. Конфигурационный файл config.php</b><Br/>
Тут задаются параметры доступа к базе данных, язык интерфейса, уровень и путь отладочного лога, а также секретный и уникальный для каждой установки ключ.
Если вы переносите базу данных на внешний сервер, то именно тут надо поправить адрес/порт, название базы, логин и пароль от базы данных (параметры $db_????).
<Br/><Br/>
Опция $sess_secret_salt содержит общий секрет, используемый для шифрования сессионных данных. При инсталляции системы пропишите туда случайное рандомное значение от какого-нибудь парольного генератора. 16-128 символов вполне достаточно. Изменение этого параметра в процессе работы приведёт к разлогиниванию всех сессий и дезактивации всех сессионных ссылок, например, ссылок для восстановления пароля.
<Br/><Br/>
$debug* - опции отладки. По умолчанию отладка выключена. Если вам надо посмотреть, что присылает регистратор и что отвечает скрипт - включите.
По умолчанию лог лежит в /tmp (подразумевается, что сервер стоит на GNU/Linux или *BSD), и этот каталог часто размещён в оперативке.
Не рекомендуется держать debug постоянно включенным.
<Br/><Br/>
Параметр $localization отвечает за язык интерфеса. По умолчанию стоит русский, что соответсвует значению ru или пустой строке.
Если указано что-то иное - строки с локализацией будут взяты из /localization/??.php.
Например, если поставить значение en, будет использоватьс файл /localization/en.php , и интерфейс будет на английском.
Структура файлов локалазации проста - это php-файл с набором строчек вида $имя_внутренней_переменной = 'Переведённое значение на нужном языке';
Вы можете создать свой вариант локализации или перевода интерфейса, взяв за основу любой из существующих шаблонов вида ??.php.
Если за основу берется русский перевод из default.php - удалите в своей копии блок if {...} (3 строчки) в конце файла !


<Br/><Br/>
<b>2. База данных MariaDB / MySQL</b><Br/>
Маловероятно, что вам придется что-то руками править в базе данных в штатном режиме.<Br/>
Однако поскольку система полностью открытая, более подробные сведения о базе данных и внутренних структурах также будут описаны.<Br/>
Все остальные настройки системы и данные о ключах, контроллерах и связанных с ними событиях лежат в этой базе данных.
Структура БД описывается файлом z5r.sql, из которого БД и создаётся при первой установке.
<Br/>
Название БД может быть любое, по умолчанию z5r. После смены названия или переноса БД внесите изменения в config.php.

<Br/><Br/>
По умолчанию все таблицы создаются с типом InnoDB, то есть все внесённые данные хранятся постоянно.
Однако в ряде случаев (как правило, если вообще не нужна отчётность, а нужно только управление ключами и проксирование событий)
часть таблиц могут использовать тип хранилища MEMORY. В этом случае данные будут лежать в оперативной памяти, и будут
автоматически стёрты при рестарте сервера БД. Контроль за количеством записей и расходами памяти в случае MEMORY-таблицы остаются на ваше усмотрение.

<Br/><Br/>
Связи между таблицами представлены вот такой схемой:
<Br/> <img src="db_scheme.png" alt="z5r MySQL database structure"> <Br/>
Из важного - таблицы снизу, у которых нарисована иконка оперативной памяти - МОГУТ быть переведены на тип хранения MEMORY.
При таком сценарии рестарт сервера очистит логи и последние состояния, и они будут автоматически обновлены и заполнены заново
по мере поступления событий от контроллеров.
<Br/><Br/>
При типе хранения по-умолчанию (InnoDB) рестарт сервера БД абсолютно безопасен, все данные останутся на месте.
Однако при большом потоке событий соответсвующие таблицы могут расти. Лимит их роста и срок хранения данных - на ваше усмотрение.
Также для таблиц с иконкой допустимо делать полную очистку записей, в том числе через вызов TRUNCATE.
В этом случае будут стёрты данные о последней активности ключей и логи по проходам для отчётов.
<Br/><Br/>
Некоторые внутрисистемные данные лежат прямо в таблицах БД, и по умолчанию не локализованы (записаны на английском) и могут быть изменены только прямой правкой БД. Сюда относятся, например, внутренние названия кодов событий и цвета раскрасок эти событий.
<Br/><Br/>
По ключам.<Br/><Br/>
Для контроллеров используется естественный первичный ключ из серийного номера и модели оборудования.
Сейчас поддерживается только одна модель - Z5RWEB.
<Br/>
Для пользователей (тех, кому выдаются ключи) внутри системы используется целочисленный ключ, но все привязки между таблицами сделаны по значению em-marine-кода в формате xxxx,ddd,ddddd. То есть сперва идут два байта серии/коммунити в шестнадцатиричном виде, потом код карты в виде (3,5) - восемь десятичных цифр. Такой формат использует исходное ПО Z5RWEB, он и используется.
<Br/><Br/>
Таблицы:<Br/>
<ul>
  <li> <i>event_codes</i> - справочная таблица с кодами событий и их названиями. Значение id строго равно значению возвращаемого оборудованием кода события. Поля name и severity_color отвечают за название события и цвет, которым события будут раскрашены в интерфейсе,
  их можно менять по желанию. События, код которых не перечислен тут, будут выводиться без названия и цветовой маркировки. Правкой этих таблиц можно поменять названия событий и цвет раскраски.
  <li> <i>proxy_event</i> - таблица редиректов (проксирования) событий. Когда система получает от контрроллера событие, в зависимости от условий (код события, серийник контроллера) система может передать это событие в другую систему (на сторонний сервер) отдельным HTTP-запросом. Поддерживается передача ряда параметров и несколько методов запроса.
  <li> <i>controller_names</i> - Таблица зарегистрированных контроллеров. Для каждого контроллера можно указать, в каком офисе он стоит, как его называть и с каких адресов допустимо принимать события для заданного контроллера. Если контроллер поменяет IP-адрес, то при заполненном значении allowed_ip_range должен содержать правильное значение.
  <li> <i>logins</i> - Логины операторов системы, тех, кто управляет ключами, контроллерами и настройками системы. По умолчанию создан логин admin с пустым паролем. 
  <li> <i>offices</i> - офисы.
  <li> <i>user_keys</i> - Данные о зарегистрированных ключах (карточках) сотрудников. В таблице хранится логин (ФИО), офис сотрудника, которому дан доступ, дата создания, карта расписаний интервалов времени по-умолчанию для данного сотрудника.
  <li> <i>bad_keys</i> - таблица кодов скомпрометированных ключей. Такие ключи система не даст добавлять в контроллеры. Обычно это "универсальные" ключи от домофонов, например, FFFF,255,65535.
  <li> <i>queue_commands</i> - В режиме Web-JSON контроллер получает команды не сразу, а только получив задание при очередном опросе сервера, обычно раз в 10 секунд. В эту таблицу кладутся запланированные команды, которые будут выполнены. Обычно, это команды управления ключами. После выполнения запись о команде помечается датой исполнения и более контроллеру не отправляется.
  Может быть типа MEMORY, если вам не нужна история с детальными записями об отправленных контроллерам JSON-командах.
  <li> <i>events</i> - Лог событий. Самая большая и быстро растущая таблица. По ёе историческим данным строятся отчёты. Если вам нужно
  только управление ключами, и исторические данные о проходах и отчёты по проходам не нужны, тоже можно перевести в тип MEMORY.
  <li> <i>last_state</i> - последнее состояние каждого контроллера. Один контроллер - одна запись. Легко может быть типа MEMORY, в этом случае при рестарте сервера БД система обновит данные о последнем успешном/не успешном входе только при получении новых событий нужного типа.
  <li> <i>last_activity_keys</i> - Данные, когда каждый ключ использовался последний раз. Используется в отчётах. Может быть типа MEMORY, если эти данные не важны.
  <li> <i>options</i> - хранит глобальные настройки системы, которые можно поменять из веб-интерфейса.
</ul>

<Br/><Br/>
<b>3. Web-интерфейс</b><Br/>
Доступен по ссылке /admin.php , при обращении к адресу, где установлена система из клиентского браузера, редирект будет автоматически.
Для определения условий редиректа сверяется заголовок User-Agent с регулярным выражением из настроек.
Для первого входа введите логин admin , поле пароля оставьте пустым. Назначьте новый пароль, без назначения пароля продолжить работу будет невозможно. Веб-интерфейс будет выглядеть примерно вот так:
<Br/><img src="screenshot.png" alt="ACSWebAdmin admin web-interface">
<Br/>
В верхней строке видны следующие ссылки:
<ul>
  <li>имя_пользователя@IP
      <Br/> Эта ссылка ведёт на профиль пользователя. В профиле пользователь может посмотреть данные профиля и поменять часть из них. Здесь же пользователь может добавить двухфакторную аутентификацию. Через настройки можно задать, какие опции будут доступны пользователю для изменений.<Br/><Br/>
  <li>Название установленного экземпляра системы
      <Br/>Эта ссылка ведёт на главную страницу со сводной статистикой.<Br/><Br/>
  <li>ссылка для выхода
      <Br/>Завершает сессию. Данные сессии опираются на стандартный механизм сессий. Сессии привязаны к текущему дню, IP и UserAgent (переменная $sess_control_string в admin.php).<Br/><Br/>
</ul>
Далее идёт меню, дающие доступ к основным сущностям системы.

<ul>
  <li>Контроллеры
      <Br/>Здесь отображаются контроллеры, добавленные автодетектом или вручную. Для каждого контроллера выводится название, офис, серийник и сводка по последней активности.
      Также здесь можно отредактировать данные по контроллеру или вообще его удалить, посмотреть логи событий и историю выполненных команд, а также дать команду на открытие двери (если есть все требуемые для этого права доступа). Неактивные контроллеры из базы не удаляются, они отображаются бледным текстом внизу списка.
      <Br/><Br/>
      Если вы удалите контроллер из базы, но не отключите авто-регистрацию, то он будет снова добавлен в базу, если будет отправлять данные в систему.
      Удаление контроллера из базы не отправляет ему никаких команд, и никак не влияет на ранее добавленные ему ключи и доступы, а также его конфигурацию. Равно как и добавление контроллера в базу не вызывает каких-либо изменений в его конфигурации. Доступы меняются только после того, как на заданный контроллер будут отправлены команды (например, на добавление ключа или смену расписания доступов).
      <Br/><Br/>
      В зависимости от прав доступа, часть функций могут быть недоступны, если ваш системный администратор отключил их для вашего логина или настроил ограничения доступных функций по IP-адресам. Также при отсутствии полных прав на управление ключами вместо номера карты будут отображаться **** звёздочки<Br/>
      Действия с контроллером доступны под такими иконками (в рамках минималистичности дизайна используются символы юникода, а не графика):<Br/>
      🖊 - редактирование данных ; 🗑 - удаление контроллера из базы; 💻 - выполненные команды, статистика ; 📜 - детальный лог событий ;  🚪 - открыть дверь.
      <Br/><Br/>
  <li>Ключи<Br/>
      <img src="screenshot_keys.png">
      <Br/>Здесь ведётся список сотрудников и их пропусков. Для Z5RWEB обычно используются карты em-marine и протокол iButton с 5-байтным кодом. Каждый ключ пишется в формате XXXX,ddd,ddddd ,
      то есть перва идут два байта в шестнадцатиричном представлении, потом три байта в десятичном. Такой формат использует ПО Guard Commander и в таком виде они выгружаются из исходного софта вендора. Для упрощения работы был реализован такой же формат хранения.<Br/><Br/>
      В зависимости от прав доступа, часть функций могут быть недоступны, если ваш системный администратор отключил их для вашего логина или настроил ограничения доступных функций по IP-адресам. Также при отсутствии полных прав на управление ключами вместо номера карты будут отображаться **** звёздочки<Br/>
      Например, можно создать такой логин, который сможет добавлять/отзывать доступы в контроллеры, но не будет видеть коды ключей.<Br/>
      Действия с ключом обозначены под такими иконками:<Br/>
      🖊 - редактирование данных ; 🗑 - удаление контроллера из базы; ⚙ - поменять уровень доступа ключа на контроллере (накатка ключей).<Br/><Br/>
      При добавлении нового ключа он сразу будет добавлен в выбранный контроллер с доступом в любое время. Доступ можно отозвать отдельно. Простое добавление ключа без операций с контроллером не реализовано, ибо достаточно бессмысленно.<Br/>
      Ранее добавленный ключ можно накатить на любой другой контроллер с любым значением TZ (расписанием доступов). В базе хранится лишь рекомендуемое/вычисленное значение TZ для пользователя, при накатке ключа его можно задать самому.<Br/>
      Редактирование ключа позволяет поменять имя пользователя, описание и его офис, а также поменять расписание доступа. К сожалению, текущее API Z5RWeb не позволяет получать данные о сконфигурированных на контроллере расписаниях, поэтому доступно только редактирование параметра TZ, представляющего собой битовую маску доступных расписаний доступа.
      Наиболее важны числа 0 (нет доступа) и 255 (доступ в любое время). Всё остальное требует отдельного конфигурирования расписаний на контроллере и вычисление значений TZ по инструкции производителя контроллера. Процедура редактирования ключа лишь меняет параметры по умолчанию, в контроллеры она ничего не отправляет.<Br/>
      Удаление ключа по умолчанию предлагает лишь его удаление из выбранного контроллера. Для полного удаления ключа из базы и всех контроллеров внутри формы удаления есть отдельная ссылка. Контроллеры, не имеющие связи с сервером, не смогут обработать такие команды.<Br/>
      Прямое редактирование кодов ключей не допускается. При утрате ключа сперва полностью удалите его из контроллеров и базы через диалог удаления, и вместо него добавьте новый ключ.<Br/>
      В настоящий момент поддерживаются только обычные ключи (SIMPLE). Поддержка мастер-ключей и блокирующих ключей пока не реализована.
      <Br/><Br/>
  <li>Офисы
      <Br/>Служат для группировки ключей и контроллеров по филиалам. Добавление ключа или контроллера к заданному офису не влияет на какие-либо доступы само по себе и ничего не меняет в контроллерах. Также принадлежность к офису используется в отчётах. Ситуация, когда один сотрудник имеет доступ в разные офисы одним ключом - вполне штатная.<Br/><Br/>
  <li>Логины
      <Br/>Здесь задаются логины администраторов / сотрудников СБ. Эта секция доступна только тем, у кого есть доступ на управление логинами. В противном случае тут отображается лишь профиль
      залогиненного пользователя. В качестве мер усиления защиты доступны ограничения по IP-адресам, откуда разрешён логин и несколько методов двухфакторной аутентификации.<Br/>
      Пустое значение IP-фильтра соответсвует отсутствию ограничений по IP. Формат - адреса/подсети, разделённые запятыми или пробелами.
      <Br/><Br/>
  <li>Говноключи
      <Br/>Это ключи чёрного списка, которые нельзя добавлять в контроллеры. Важный момент - если такой ключ уже был добавлен в контроллер ранее, то сам он оттуда не удалится.
      Этот список лишь предотвращает добавление подобных ключей через веб-интерфейс и API.<Br/><Br/>
  <li>Прокси
      <Br/>Тут настраивается проксирование событий. Когда на каком-либо контроллере произойдёт что-то интересное, то система сама может отправить http-запрос к внешней системе,
      передав параметры из запроса, как параметрами, так и в теле запроса. Поддерживаются методы GET, POST, PUT<Br/>
      Это нужно для интеграции с внешними системами - например, видеонаблюдением, SIEM, службами каталогов или внешними системами отчётности.
      <Br/><Br/>
  <li>Настройки
      <Br/>Тут задаются глобальные настройки. Наиболее важны списки для ограничения доступных функций по IP. Названия параметров локализованы.
      <Br/><Br/>
  <li>Конвертер
      <Br/>Вспомогательная форма для конвертирования ключей и TZ-параметров.
      <Br/><Br/>
  <li>Отчёты
      <Br/>Здесь можно сформировать простые отчёты по проходам, ключам и событиям. Каждый отчёт представлен отдельным php-файлом из каталога /reports<Br/><Br/>
      Для добавления своего отчёта сделайте следующее:<Br/>
      - придумайте имя файла (на английском, системное имя) и название отчёта<Br/>
      - Добавьте системное имя в массив $reports_array в файле /reports/index.php<Br/>
      - Создайте переменную в файлах локализации (localization/**.php) loc_reports_{системное имя} для отображения названия отчёта на всех языках<Br/>
      - Создайте файл /reports/{системное имя}.php на основе любого из существующих<Br/><Br/>
      Пулл-реквесты приветствуются.
      <Br/><Br/>
</ul>

</div>
</body></html>
